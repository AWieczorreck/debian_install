#!/usr/bin/env bash

DMENU="${DMENU:-dmenu}"

mapfile -t oath_accounts < <(ykman oath accounts list 2>/dev/null)

if [[ ${#oath_accounts[@]} -eq 0 ]]; then
  notify-send "totp-menu" "Kein YubiKey gefunden oder keine OATH-Accounts vorhanden."
  exit 1
fi

selected=$(printf '%s\n' "${oath_accounts[@]}" | $DMENU -p "2FA-Account:")
[[ -z "$selected" ]] && exit 0

totp=$(ykman oath accounts code "$selected" 2>/dev/null | awk '{print $NF}')

if [[ -z "$totp" ]]; then
  notify-send "totp-menu" "Konnte keinen TOTP-Code abrufen."
  exit 1
fi

echo -n "$totp" | xclip -selection clipboard
